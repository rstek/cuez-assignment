sequenceDiagram
    participant User
    participant Client
    participant Route
    participant Queue
    participant Jobs
    participant Events
    participant OTEL
    participant DB

    Note over OTEL: Root Span Created
    User->>Route: POST /episodes/{id}/duplicate
    Route->>DB: INSERT EpisodeDuplication (status=pending)
    Route->>Queue: Dispatch Job Chain
    Route-->>User: 202 Accepted {duplication_id}

    Note over Queue,Jobs: Job 1: DuplicateEpisode
    Queue->>Jobs: DuplicateEpisode
    Note over OTEL: Span: duplicate-episode
    Jobs->>DB: SELECT original episode

    rect rgb(200, 230, 255)
        Note over Jobs,DB: Transaction (attempts: 3)
        Jobs->>DB: INSERT new episode (replicate)
        Jobs->>DB: UPDATE duplication.new_episode_id
    end

    Jobs->>Events: duplication.started
    Events-->>Client: Broadcast (WebSocket)
    Jobs->>Queue: Chain: DuplicateParts

    Note over Queue,Jobs: Job 2: DuplicateParts (Simple Chunking)
    Queue->>Jobs: DuplicateParts
    Note over OTEL: Span: duplicate-parts

    loop Chunk original Parts (size: 100)
        Jobs->>DB: SELECT chunk of original parts
        Note over Jobs: Prepare bulk insert data

        rect rgb(200, 230, 255)
            Note over Jobs,DB: Transaction (attempts: 3)
            Jobs->>DB: Bulk INSERT new parts
            Jobs->>DB: UPDATE duplication.progress
        end

        Jobs->>Events: duplication.progress
        Events-->>Client: Broadcast Progress
    end

    Jobs->>Queue: Chain: DuplicateItems

    Note over Queue,Jobs: Job 3: DuplicateItems (2-Level Nested Chunking)
    Queue->>Jobs: DuplicateItems
    Note over OTEL: Span: duplicate-items

    loop Chunk duplicated Parts (size: 1000)
        Jobs->>DB: SELECT duplicated parts (orig_id IS NOT NULL)
        Note over Jobs: Build orig_id → new_id map

        loop Chunk original Items (size: 100)
            Jobs->>DB: SELECT original items (by orig part_id)
            Note over Jobs: Map part_id using duplicated parts

            rect rgb(200, 230, 255)
                Note over Jobs,DB: Transaction (attempts: 3)
                Jobs->>DB: Bulk INSERT new items
                Jobs->>DB: UPDATE duplication.progress
            end

            Jobs->>Events: duplication.progress
            Events-->>Client: Broadcast Progress
        end
    end

    Jobs->>Queue: Chain: DuplicateBlocks

    Note over Queue,Jobs: Job 4: DuplicateBlocks (3-Level Nested Chunking)
    Queue->>Jobs: DuplicateBlocks
    Note over OTEL: Span: duplicate-blocks

    loop Chunk duplicated Parts (size: 1000)
        Jobs->>DB: SELECT duplicated parts (orig_id IS NOT NULL)

        loop Chunk duplicated Items (size: 100)
            Jobs->>DB: SELECT duplicated items (orig_id IS NOT NULL)
            Note over Jobs: Build orig_id → new_id map

            loop Chunk original Blocks (size: 200)
                Jobs->>DB: SELECT original blocks (by orig item_id)
                Note over Jobs: Map item_id using duplicated items

                rect rgb(200, 230, 255)
                    Note over Jobs,DB: Transaction (attempts: 3)
                    Jobs->>DB: Bulk INSERT new blocks
                    Jobs->>DB: UPDATE duplication.progress
                end

                Jobs->>Events: duplication.progress
                Events-->>Client: Broadcast Progress
            end
        end
    end

    Jobs->>Events: duplication.completed
    Events-->>Client: Broadcast Complete + Notification
    Note over OTEL: Close Root Span

    alt Failure at any stage
        Jobs->>DB: UPDATE duplication.status=failed
        Jobs->>Events: duplication.failed
        Events-->>Client: Broadcast Error + Notification
        Note over OTEL: Record Exception in Span
    end